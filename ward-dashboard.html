<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRDSS Ward Risk Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; } /* æ·ºç¶ è‰²èƒŒæ™¯ */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .input-card { transition: all 0.2s; }
        .input-card:hover { border-color: #34d399; }
        .input-group { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        /* ç•¶ CRS å¤±æ•ˆæ™‚çš„è¦–è¦ºæ¨£å¼ */
        .crs-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-emerald-900 text-white px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-md">
        <div class="flex items-center gap-4">
            <div class="bg-emerald-500 px-3 py-1 rounded font-bold text-sm tracking-wide">WARD MODE</div>
            <h1 class="text-lg font-semibold">AIRDSS Hybrid <span class="text-emerald-200 text-sm font-normal">| ä¸€èˆ¬ç—…æˆ¿æ™è„«é¢¨éšªè©•ä¼°</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right mr-2">
                <div class="text-sm font-bold">ç—…åºŠ: 07-A</div>
                <div class="text-xs text-emerald-200">æ—é˜¿å¬¤ (82 F)</div>
            </div>
            <button onclick="toggleCRSValidity()" id="btn-crs-status" class="bg-white text-emerald-800 text-xs px-3 py-2 rounded transition font-bold border border-emerald-200 hover:bg-emerald-50">
                ğŸŸ¢ æ¨¡æ“¬ï¼šCRS è³‡æ–™æœ‰æ•ˆ
            </button>
            <button onclick="window.location.href='index.html'" class="bg-emerald-800 hover:bg-emerald-700 text-emerald-100 text-xs px-3 py-2 rounded transition border border-emerald-600">
                é€€å‡º
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <div class="lg:col-span-5 space-y-6">
            
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-8 border-emerald-500 transition-colors duration-300" id="trs-card">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-slate-500 text-sm font-bold uppercase tracking-wider">TRS ç¸½é¢¨éšªåˆ†æ•¸</h2>
                    <span id="calc-mode-badge" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full">Hybrid Mode (ARS+CRS)</span>
                </div>
                
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <span id="trs-score" class="text-6xl font-bold text-slate-800">0.00</span>
                        <span class="text-slate-400 text-lg">/ 1.0</span>
                    </div>
                    <div id="risk-badge" class="px-4 py-2 rounded-lg bg-emerald-100 text-emerald-700 font-bold">
                        ä½é¢¨éšª (Low)
                    </div>
                </div>

                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden flex mb-2">
                    <div id="bar-ars" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                    <div id="bar-crs" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mb-4">
                    <span id="label-ars">ARS æ¬Šé‡ (60%)</span>
                    <span id="label-crs">CRS æ¬Šé‡ (40%)</span>
                </div>

                <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                    <h3 class="text-xs font-bold text-emerald-800 mb-1">ç…§è­·è¡Œå‹•å»ºè­°ï¼š</h3>
                    <p id="action-text" class="text-sm font-medium text-slate-700">å¸¸è¦ç…§è­·</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-2 py-1 rounded-bl">Auto (Sensor)</div>
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    ARS æ„Ÿæ¸¬æŒ‡æ¨™ 
                    <span id="ars-total" class="text-blue-600 text-sm bg-blue-50 px-2 py-0.5 rounded">0 / 10åˆ†</span>
                </h3>

                <div class="mb-4">
                    <h4 class="text-xs font-bold text-slate-400 mb-2">PBS è¡Œç‚ºç›£æ¸¬ (0-2)</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 rounded border border-slate-200">
                            <div class="text-xs text-slate-500">æ‹‰æ‰¯é »ç‡</div>
                            <div class="font-mono text-lg font-bold">0.2 /sec</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded border border-slate-200">
                            <div class="text-xs text-slate-500">æ‹‰åŠ›å³°å€¼</div>
                            <div class="font-mono text-lg font-bold">0.5 kg</div>
                        </div>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <label class="flex items-center gap-2 text-xs cursor-pointer bg-slate-50 px-2 py-1 rounded border border-slate-200 hover:bg-white transition">
                            <input type="checkbox" id="sim-pull" onchange="updateCalc()" class="rounded text-blue-600">
                            æ¨¡æ“¬é«˜é »æ‹‰æ‰¯ <span class="text-blue-600 font-bold">+1</span>
                        </label>
                        <label class="flex items-center gap-2 text-xs cursor-pointer bg-slate-50 px-2 py-1 rounded border border-slate-200 hover:bg-white transition">
                            <input type="checkbox" id="sim-force" onchange="updateCalc()" class="rounded text-blue-600">
                            æ¨¡æ“¬é«˜æ‹‰åŠ› <span class="text-blue-600 font-bold">+1</span>
                        </label>
                    </div>
                </div>

                <hr class="my-4 border-slate-100">

                <div>
                    <h4 class="text-xs font-bold text-slate-400 mb-2">PTS ç”Ÿç†è¶¨å‹¢ (0-8)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-xs text-slate-500 flex justify-between">
                                HR (bpm) <span id="score-hr" class="font-bold text-blue-600">+0</span>
                            </label>
                            <select id="input-hr" onchange="updateCalc()" class="w-full mt-1 bg-transparent border-none text-sm font-bold focus:ring-0 cursor-pointer">
                                <option value="0">60-100 (Normal)</option>
                                <option value="1">101-120 (+1)</option>
                                <option value="2">> 120 (+2)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="text-xs text-slate-500 flex justify-between">
                                RR (/min) <span id="score-rr" class="font-bold text-blue-600">+0</span>
                            </label>
                            <select id="input-rr" onchange="updateCalc()" class="w-full mt-1 bg-transparent border-none text-sm font-bold focus:ring-0 cursor-pointer">
                                <option value="0">&lt; 20 (Normal)</option>
                                <option value="1">21-30 (+1)</option>
                                <option value="2">> 30 (+2)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="text-xs text-slate-500 flex justify-between">
                                SpO2 (%) <span id="score-spo2" class="font-bold text-blue-600">+0</span>
                            </label>
                            <select id="input-spo2" onchange="updateCalc()" class="w-full mt-1 bg-transparent border-none text-sm font-bold focus:ring-0 cursor-pointer">
                                <option value="0">> 94 (Normal)</option>
                                <option value="1">90-93 (+1)</option>
                                <option value="2">&lt; 90 (+2)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="text-xs text-slate-500 flex justify-between">
                                SBP (mmHg) <span id="score-sbp" class="font-bold text-blue-600">+0</span>
                            </label>
                            <select id="input-sbp" onchange="updateCalc()" class="w-full mt-1 bg-transparent border-none text-sm font-bold focus:ring-0 cursor-pointer">
                                <option value="0">&lt; 120 (Normal)</option>
                                <option value="1">120-160 (+1)</option>
                                <option value="2">> 160 (+2)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-200 relative">
                
                <div id="crs-overlay" class="hidden absolute inset-0 z-10 bg-white/60 backdrop-blur-[1px] flex items-center justify-center rounded-xl">
                    <div class="bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl text-center">
                        <div class="text-xl font-bold mb-1">âš ï¸ CRS è©•ä¼°å·²éæœŸ</div>
                        <div class="text-sm opacity-80">ç³»çµ±å·²åˆ‡æ›è‡³ã€Œåƒ… ARS æ¨¡å¼ã€ä»¥ç¢ºä¿å®‰å…¨</div>
                        <div class="text-xs mt-2 text-slate-400">è«‹ç›¡å¿«æ›´æ–°è©•ä¼°æ•¸æ“š</div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div>
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            CRS è‡¨åºŠè©•ä¼° (ç—…æˆ¿ç‰ˆ)
                            <span id="crs-total" class="text-emerald-600 text-sm bg-emerald-50 px-2 py-0.5 rounded">0 / 14åˆ†</span>
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">é—œæ³¨è·Œå€’ã€é™ªä¼´èˆ‡ç’°å¢ƒå› å­ (æ¬Šé‡ 40%)</p>
                    </div>
                    <button class="text-sm text-emerald-600 hover:underline" onclick="resetCRS()">é‡ç½®è¡¨å–®</button>
                </div>

                <div id="crs-form-content" class="space-y-6">
                    
                    <div class="input-card bg-red-50 p-4 rounded-lg border border-red-100">
                        <h4 class="text-sm font-bold text-red-700 mb-3 flex justify-between">
                            1. Fall è·Œå€’é¢¨éšªè©•ä¼° (0 æˆ– 3)
                            <span class="text-xs font-normal text-red-500 bg-white px-2 py-1 rounded">é«˜æ¬Šé‡å› å­</span>
                        </h4>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="fall_risk" value="0" checked onchange="updateCalc()" class="w-4 h-4 text-red-600">
                                <span>éé«˜é¢¨éšª (0åˆ†)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700">
                                <input type="radio" name="fall_risk" value="3" onchange="updateCalc()" class="w-4 h-4 text-red-600">
                                <span>âš ï¸ é«˜é¢¨éšªæ—ç¾¤ (3åˆ†)</span>
                            </label>
                        </div>
                    </div>

                    <div class="input-card bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-700 mb-3">2. Support é™ªä¼´ç‹€æ…‹ (0-1)</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-600">ç›®å‰æ˜¯å¦æœ‰å®¶å±¬æˆ–çœ‹è­·é™ªä¼´ï¼Ÿ</span>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="support_status" value="0" checked onchange="updateCalc()" class="text-emerald-600">
                                    <span>æœ‰é™ªä¼´ (0åˆ†)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="support_status" value="1" onchange="updateCalc()" class="text-emerald-600">
                                    <span class="font-bold text-orange-600">ç„¡é™ªä¼´ (1åˆ†)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-card border p-3 rounded-lg">
                            <label class="block text-xs font-bold text-slate-500 mb-1">3. GCS (0-2)</label>
                            <select id="input-gcs" onchange="updateCalc()" class="w-full text-sm p-1 rounded">
                                <option value="0"><8 æˆ– 15 (0åˆ†)</option>
                                <option value="1">13-14 (1åˆ†)</option>
                                <option value="2">9-12 (2åˆ†)</option>
                            </select>
                        </div>
                        <div class="input-card border p-3 rounded-lg">
                            <label class="block text-xs font-bold text-slate-500 mb-1">4. Pain (0-2)</label>
                            <select id="input-pain" onchange="updateCalc()" class="w-full text-sm p-1 rounded">
                                <option value="0">NRS 0-3 (0åˆ†)</option>
                                <option value="1">NRS 4-6 (1åˆ†)</option>
                                <option value="2">NRS â‰¥7 (2åˆ†)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-card border p-3 rounded-lg">
                            <label class="block text-xs font-bold text-slate-500 mb-2">5. Hx æ—¢å¾€å² (0-1)</label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="input-hx" onchange="updateCalc()" class="rounded text-emerald-600">
                                <span class="text-sm">å¤±æ™ºå²æˆ–è­«å¦„å² (+1)</span>
                            </label>
                        </div>
                        <div class="hidden md:block"></div>
                    </div>

                    <div class="input-card border p-3 rounded-lg">
                        <h4 class="text-xs font-bold text-slate-500 mb-2">6. Tube ç®¡è·¯ (0-3)</h4>
                        <div class="space-y-2">
                            <div class="flex flex-wrap gap-4 text-sm">
                                <label><input type="radio" name="ward_tube" value="0" checked onchange="updateCalc()"> ç„¡</label>
                                <label><input type="radio" name="ward_tube" value="1" onchange="updateCalc()"> ä½é¢¨éšª (IV/Foley)</label>
                                <label><input type="radio" name="ward_tube" value="2" onchange="updateCalc()"> é«˜é¢¨éšª (NG/PICC)</label>
                            </div>
                            <label class="flex items-center gap-2 text-sm text-red-600 cursor-pointer pt-1 border-t border-dashed">
                                <input type="checkbox" id="ward-tube-exposed" onchange="updateCalc()" class="rounded text-red-600">
                                <span>ç®¡è·¯æš´éœ² (Exposed) +1</span>
                            </label>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        let isCRSValid = true;

        // åˆ‡æ› CRS æœ‰æ•ˆæ€§æ¨¡æ“¬
        function toggleCRSValidity() {
            isCRSValid = !isCRSValid;
            const btn = document.getElementById('btn-crs-status');
            const overlay = document.getElementById('crs-overlay');
            const modeBadge = document.getElementById('calc-mode-badge');
            
            if (isCRSValid) {
                btn.innerHTML = "ğŸŸ¢ æ¨¡æ“¬ï¼šCRS è³‡æ–™æœ‰æ•ˆ";
                btn.classList.replace('text-red-800', 'text-emerald-800');
                btn.classList.replace('border-red-200', 'border-emerald-200');
                btn.classList.replace('hover:bg-red-50', 'hover:bg-emerald-50');
                overlay.classList.add('hidden');
                modeBadge.innerText = "Hybrid Mode (ARS+CRS)";
            } else {
                btn.innerHTML = "ğŸ”´ æ¨¡æ“¬ï¼šCRS è³‡æ–™éæœŸ";
                btn.classList.replace('text-emerald-800', 'text-red-800');
                btn.classList.replace('border-emerald-200', 'border-red-200');
                btn.classList.replace('hover:bg-emerald-50', 'hover:bg-red-50');
                overlay.classList.remove('hidden');
                modeBadge.innerText = "Safety Mode (ARS Only)";
            }
            updateCalc();
        }

        // è¡Œå‹•å»ºè­°
        function getActionText(score) {
            if (score >= 0.7) return "ç«‹å³åºŠé‚Šè©•ä¼°ã€ä¿è­·ç®¡è·¯ã€é€šå ±"; // High
            if (score >= 0.3) return "è£œé™ªä¼´ã€è™•ç†ä¸é©ã€æª¢æŸ¥ç®¡è·¯"; // Medium (Ward specific)
            return "å¸¸è¦ç…§è­·"; // Low
        }

        function updateCalc() {
            // --- 1. ARS (0-10) - Now using Select inputs for PTS ---
            let pbs = 0;
            if(document.getElementById('sim-pull').checked) pbs += 1;
            if(document.getElementById('sim-force').checked) pbs += 1;

            let pts = 0;
            // HR [cite: 113]
            const valHr = document.getElementById('input-hr').value;
            pts += parseInt(valHr);
            document.getElementById('score-hr').innerText = `+${valHr}`;

            // RR [cite: 113]
            const valRr = document.getElementById('input-rr').value;
            pts += parseInt(valRr);
            document.getElementById('score-rr').innerText = `+${valRr}`;

            // SpO2 [cite: 113]
            const valSpo2 = document.getElementById('input-spo2').value;
            pts += parseInt(valSpo2);
            document.getElementById('score-spo2').innerText = `+${valSpo2}`;

            // SBP [cite: 113]
            const valSbp = document.getElementById('input-sbp').value;
            pts += parseInt(valSbp);
            document.getElementById('score-sbp').innerText = `+${valSbp}`;

            let rawArs = pbs + pts;
            // Cap rawArs at 10 if necessary, though logical max is 2+8=10
            let normArs = rawArs / 10;
            document.getElementById('ars-total').innerText = `${rawArs} / 10åˆ†`;

            // --- 2. CRS (0-14) Ward Version ---
            // Fall
            let fallScore = 0;
            document.getElementsByName('fall_risk').forEach(el => {
                if(el.checked) fallScore = parseInt(el.value);
            });

            // Support
            let supportScore = 0;
            document.getElementsByName('support_status').forEach(el => {
                if(el.checked) supportScore = parseInt(el.value);
            });

            // GCS, Pain, Hx
            let gcsScore = parseInt(document.getElementById('input-gcs').value);
            let painScore = parseInt(document.getElementById('input-pain').value);
            let hxScore = document.getElementById('input-hx').checked ? 1 : 0;

            // Tube (Ward)
            let tubeBase = 0;
            document.getElementsByName('ward_tube').forEach(el => {
                if(el.checked) tubeBase = parseInt(el.value);
            });
            let tubeExposed = document.getElementById('ward-tube-exposed').checked ? 1 : 0;
            let tubeScore = tubeBase + tubeExposed;
            if(tubeScore > 3) tubeScore = 3; // Max cap

            let rawCrs = fallScore + supportScore + gcsScore + painScore + hxScore + tubeScore;
            // Cap at 14
            if(rawCrs > 14) rawCrs = 14; 
            let normCrs = rawCrs / 14;

            document.getElementById('crs-total').innerText = `${rawCrs} / 14åˆ†`;

            // --- 3. TRS Calculation ---
            let trs = 0;
            let arsDisplayWidth = 0;
            let crsDisplayWidth = 0;

            if (isCRSValid) {
                // Hybrid Calculation
                trs = (0.6 * normArs) + (0.4 * normCrs);
                arsDisplayWidth = (0.6 * normArs) * 100;
                crsDisplayWidth = (0.4 * normCrs) * 100;
                
                document.getElementById('label-ars').innerText = "ARS æ¬Šé‡ (60%)";
                document.getElementById('label-crs').innerText = "CRS æ¬Šé‡ (40%)";
                document.getElementById('label-crs').classList.remove('line-through', 'opacity-50');
            } else {
                // Safety Mode: Use ARS Only
                trs = normArs; 
                arsDisplayWidth = normArs * 100;
                crsDisplayWidth = 0;

                document.getElementById('label-ars').innerText = "ARS æ¬Šé‡ (100%)";
                document.getElementById('label-crs').innerText = "CRS ç„¡æ•ˆ (0%)";
                document.getElementById('label-crs').classList.add('line-through', 'opacity-50');
            }

            // Update UI
            document.getElementById('trs-score').innerText = trs.toFixed(2);
            document.getElementById('bar-ars').style.width = `${arsDisplayWidth}%`;
            document.getElementById('bar-crs').style.width = `${crsDisplayWidth}%`;

            // Risk Badge
            const badge = document.getElementById('risk-badge');
            const card = document.getElementById('trs-card');
            
            if (trs >= 0.7) {
                badge.innerText = "HIGH (é«˜é¢¨éšª)";
                badge.className = "px-4 py-2 rounded-lg font-bold bg-red-100 text-red-700";
                card.classList.remove('border-emerald-500', 'border-yellow-500');
                card.classList.add('border-red-500');
            } else if (trs >= 0.3) {
                badge.innerText = "MEDIUM (ä¸­é¢¨éšª)";
                badge.className = "px-4 py-2 rounded-lg font-bold bg-yellow-100 text-yellow-800";
                card.classList.remove('border-emerald-500', 'border-red-500');
                card.classList.add('border-yellow-500');
            } else {
                badge.innerText = "LOW (ä½é¢¨éšª)";
                badge.className = "px-4 py-2 rounded-lg font-bold bg-emerald-100 text-emerald-700";
                card.classList.remove('border-red-500', 'border-yellow-500');
                card.classList.add('border-emerald-500');
            }

            document.getElementById('action-text').innerText = getActionText(trs);
        }

        function resetCRS() {
            document.getElementsByName('fall_risk')[0].checked = true;
            document.getElementsByName('support_status')[0].checked = true;
            document.getElementById('input-gcs').value = 0;
            document.getElementById('input-pain').value = 0;
            document.getElementById('input-hx').checked = false;
            document.getElementsByName('ward_tube')[0].checked = true;
            document.getElementById('ward-tube-exposed').checked = false;
            updateCalc();
        }

        // Init
        updateCalc();

    </script>
</body>
</html>